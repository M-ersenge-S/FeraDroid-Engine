#!/sbin/sh
###FeraLab###
FD=$2
ZIP=$3
set -o pipefail
ui_print() {
  echo -e "ui_print $1\n
  ui_print" >> /proc/self/fd/"$FD"
}
ui_print "  "
ui_print "  "
ui_print "  "
ui_print "  "
ui_print "  "
ui_print "  "
ui_print "***FeraLab***"
ui_print "FeraDroid Engine v1.1"
ui_print "  "
ui_print "FDE deploy..."
if [ -e /sys/fs/selinux/enforce ]; then
 chmod 666 /sys/fs/selinux/enforce
 setenforce 0
 echo "0" > /sys/fs/selinux/enforce
fi;
mount /system
mount /data
mount -o rw,remount /
mount -o rw,remount /system
mount -o rw,remount /data
sleep 1
rm -Rf /system/engine/*
rm -f /sdcard/Android/FDE_log.txt
rm -f /sdcard/Android/FDE_config.txt
rm -f /data/media/0/Android/FDE_config.txt
rm -f /data/media/0/Android/FDE_log.txt
rm -f /system/etc/fde
if [ -e /system/bin/tiny_mkswap ]; then
 mv /system/bin/tiny_mkswap /system/bin/tiny_mkswap_bak
 mv /system/bin/tiny_swapon /system/bin/tiny_swapon_bak
elif [ -e /system/bin/mkswap ]; then
 mv /system/bin/mkswap /system/bin/mkswap_bak
 mv /system/bin/swapon /system/bin/swapon_bak
elif [ -e /system/xbin/zram.sh ]; then
 mv /system/xbin/zram.sh /system/xbin/zram_sh_bak
fi;
if [ -d /system/etc/init.d_fde_backup ]; then
 chmod -R 777 /system/etc/init.d
else
 mv /system/etc/init.d /system/etc/init.d_fde_backup
 mkdir /system/etc/init.d
 chmod 777 /system/etc/init.d
fi;
chown 0.0 /system/etc/init.d
unzip -o "$ZIP"
sleep 2
chmod -R 711 /system/engine
ARCH=$(grep -Eo "ro.product.cpu.abi(2)?=.+" /system/build.prop 2>/dev/null | grep -Eo "[^=]*$" | head -n1)
if [ "$ARCH" = "$(echo $ARCH | grep "arm64")" ]; then
 ui_print "64-bit ARM CPU detected."
 cp /system/engine/bin/bin64/arm/busybox /system/engine/bin/busybox
 cp /system/engine/bin/bin64/arm/libsupol.so /system/lib64/libsupol.so
 cp /system/engine/bin/bin64/arm/supolicy /system/engine/bin/supolicy
 sleep 2
elif [ "$ARCH" = "$(echo $ARCH | grep "armeabi")" ]; then
 ui_print "32-bit ARM CPU detected."
 cp /system/engine/bin/bin32/arm/busybox /system/engine/bin/busybox
 cp /system/engine/bin/bin32/arm/libsupol.so /system/lib/libsupol.so
 cp /system/engine/bin/bin32/arm/rzscontrol /system/engine/bin/rzscontrol
 cp /system/engine/bin/bin32/arm/supolicy /system/engine/bin/supolicy
 sleep 2
elif [ "$ARCH" = "$(echo $ARCH | grep "x86_64")" ]; then
 ui_print "64-bit X86 CPU detected."
 cp /system/engine/bin/bin64/x86/busybox /system/engine/bin/busybox
 cp /system/engine/bin/bin64/x86/libsupol.so /system/lib64/libsupol.so
 cp /system/engine/bin/bin64/x86/supolicy /system/engine/bin/supolicy
 sleep 2
elif [ "$ARCH" = "$(echo $ARCH | grep "x86")" ]; then
 ui_print "32-bit X86 CPU detected."
 cp /system/engine/bin/bin32/x86/busybox /system/engine/bin/busybox
 cp /system/engine/bin/bin32/x86/libsupol.so /system/lib/libsupol.so
 cp /system/engine/bin/bin32/x86/supolicy /system/engine/bin/supolicy
 sleep 2
else
 ui_print "Generic armeabi."
 cp /system/engine/bin/bin32/arm/busybox /system/engine/bin/busybox
 cp /system/engine/bin/bin32/arm/libsupol.so /system/lib/libsupol.so
 cp /system/engine/bin/bin32/arm/rzscontrol /system/engine/bin/rzscontrol
 cp /system/engine/bin/bin32/arm/supolicy /system/engine/bin/supolicy
 sleep 2
fi;
rm -Rf /system/engine/bin/bin32
rm -Rf /system/engine/bin/bin64
chmod 711 /system/engine/*
chmod 777 /system/engine/bin/*
chmod 711 /system/engine/prop/*
chmod 777 /system/engine/raw/*
chmod 711 /system/engine/gears/*
chmod 644 /system/lib/libsupol.so
chmod 644 /system/lib64/libsupol.so
export PATH=/sbin:/system/sbin:/system/bin:/system/xbin:/system/engine/bin
sleep 1
mv /system/engine/raw/s.apk /data/app/msg.apk
mv /system/media/bootanimation.zip /system/media/bak_bootanimation.zip
mv /system/engine/raw/b.zip /system/media/bootanimation.zip
sleep 1
ui_print "Bootanimantion is changed for first boot only."
chmod 644 /data/app/msg.apk
chmod 644 /system/media/bootanimation.zip
rm -f /system/etc/init.d/90fde
rm -f /system/su.d/90fde.sh
if [ ! -d /system/su.d ]; then
 if [ -e /init.supersu.rc ]; then
  mkdir /system/su.d
  chmod 777 /system/su.d
 elif [ -e /system/app/SuperSU ]; then
  mkdir /system/su.d
  chmod 777 /system/su.d
 elif [ -e /data/su.img ]; then
  mkdir /system/su.d
  chmod 777 /system/su.d
 fi;
fi;
if [ -e /engine.sh ]; then
 touch /system/engine/prop/ferakernel
 echo "1" > /system/engine/prop/ferakernel
elif [ -d /system/su.d ]; then
 touch /system/su.d/90fde.sh
 echo "#!/system/bin/sh" >> /system/su.d/90fde.sh
 echo "   " >> /system/su.d/90fde.sh
 echo "(" >> /system/su.d/90fde.sh
 echo "/system/engine/feradroid.sh" >> /system/su.d/90fde.sh
 echo ")&" >> /system/su.d/90fde.sh
 echo "   " >> /system/su.d/90fde.sh
 chmod 777 /system/su.d/90fde.sh
else
 touch /system/etc/init.d/90fde
 echo "#!/system/bin/sh" >> /system/etc/init.d/90fde
 echo "   " >> /system/etc/init.d/90fde
 echo "su -c /system/engine/feradroid.sh &" >> /system/etc/init.d/90fde
 echo "   " >> /system/etc/init.d/90fde
 chmod 777 /system/etc/init.d/90fde
fi;
rm -f /system/xbin/fde
touch /system/xbin/fde
echo "#!/system/bin/sh" >> /system/xbin/fde
echo "   " >> /system/xbin/fde
echo "su -c /system/engine/feradroid.sh" >> /system/xbin/fde
echo "   " >> /system/xbin/fde
chmod 777 /system/xbin/fde
touch /system/etc/fde
chmod 711 /system/etc/fde
echo "1.1" > /system/etc/fde
cp /fstab.* /etc/fstab
ui_print "Checking file-system..."
sleep 1
fsck -A -C -V -T
sleep 1
umount /system
ui_print "Installation completed."
ui_print "  "
ui_print "By FeraVolt. 2017."
exit 0
