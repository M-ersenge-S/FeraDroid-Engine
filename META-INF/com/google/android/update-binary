#!/sbin/sh
###FeraLab###
FD=$2
ZIP=$3
set -o pipefail
ui_print() {
  echo -e "ui_print $1\n
  ui_print" >> /proc/self/fd/"$FD"
}
ui_print "  "
ui_print "  "
ui_print "  "
ui_print "  "
ui_print "  "
ui_print "  "
ui_print "***FeraLab***"
ui_print "FeraDroid Engine v1.1"
ui_print "  "
ui_print "FDE deploy..."
mount /system
mount /data
mount -o rw,remount /
mount -o rw,remount /system
mount -o rw,remount /data
sleep 1
rm -Rf /system/engine/*
rm -f /sdcard/Android/FDE_log.txt
rm -f /sdcard/Android/FDE_config.txt
rm -f /sdcard/Android/FDE.txt
rm -f /sdcard/Android/sleeper_whitelist.txt
rm -f /data/media/0/Android/FDE_config.txt
rm -f /data/media/0/Android/FDE_log.txt
rm -f /data/media/0/Android/FDE.txt
rm -f /data/media/0/Android/sleeper_whitelist.txt
rm -f /system/etc/fde
if [ -e /system/bin/tiny_mkswap ]; then
 mv /system/bin/tiny_mkswap /system/bin/tiny_mkswap_bak
 mv /system/bin/tiny_swapon /system/bin/tiny_swapon_bak
elif [ -e /system/bin/mkswap ]; then
 mv /system/bin/mkswap /system/bin/mkswap_bak
 mv /system/bin/swapon /system/bin/swapon_bak
elif [ -e /system/xbin/zram.sh ]; then
 mv /system/xbin/zram.sh /system/xbin/zram_sh_bak
fi;
if [ -d /system/etc/init.d_fde_backup ]; then
 chmod -R 777 /system/etc/init.d
else
 mv /system/etc/init.d /system/etc/init.d_fde_backup
 mkdir /system/etc/init.d
 chmod 777 /system/etc/init.d
fi;
chown 0.0 /system/etc/init.d
unzip -o "$ZIP"
sleep 1
chmod -R 777 /system/engine
ARCH=$(grep -Eo "ro.product.cpu.abi(2)?=.+" /system/build.prop 2>/dev/null | grep -Eo "[^=]*$" | head -n1)
if [ "$ARCH" = "$(echo $ARCH | grep "arm64")" ]; then
 ui_print "64-bit ARM CPU detected."
 mv /system/engine/bin/bin64/arm/busybox /system/engine/bin/busybox
elif [ "$ARCH" = "$(echo $ARCH | grep "armeabi")" ]; then
 ui_print "32-bit ARM CPU detected."
 mv /system/engine/bin/bin32/arm/busybox /system/engine/bin/busybox
 mv /system/engine/bin/bin32/arm/rzscontrol /system/engine/bin/rzscontrol
elif [ "$ARCH" = "$(echo $ARCH | grep "x86_64")" ]; then
 ui_print "64-bit X86 CPU detected."
 mv /system/engine/bin/bin64/x86/busybox /system/engine/bin/busybox
elif [ "$ARCH" = "$(echo $ARCH | grep "x86")" ]; then
 ui_print "32-bit X86 CPU detected."
 mv /system/engine/bin/bin32/x86/busybox /system/engine/bin/busybox
else
 ui_print "armeabi bb."
 mv /system/engine/bin/bin32/arm/busybox /system/engine/bin/busybox
 mv /system/engine/bin/bin32/arm/rzscontrol /system/engine/bin/rzscontrol
fi;
rm -Rf /system/engine/bin/bin32
rm -Rf /system/engine/bin/bin64
chmod 777 /system/engine/*
chmod 777 /system/engine/bin/*
chmod 777 /system/engine/prop/*
chmod 777 /system/engine/raw/*
chmod 777 /system/engine/gears/*
/system/engine/bin/busybox --install -s /system/xbin
cp -f /system/engine/raw/showtoast.apk /data/app/showtoast.apk
chmod 644 /data/app/showtoast.apk
mv /system/media/bootanimation.zip /system/media/bak_bootanimation.zip
cp -f /system/engine/raw/b.zip /system/media/bootanimation.zip
chmod 644 /system/media/bootanimation.zip
rm -f /system/etc/init.d/90fde
if [ -e /engine.sh ]; then
 touch /system/engine/prop/ferakernel
 echo "1" > /system/engine/prop/ferakernel
elif [ -e /system/bin/sysinit ]; then
 rm -f /system/bin/sysinit
 touch /system/bin/sysinit
 echo "#!/system/bin/sh" >> /system/bin/sysinit
 echo "   " >> /system/bin/sysinit
 echo "export PATH=/sbin:/system/sbin:/system/bin:/system/xbin" >> /system/bin/sysinit
 echo "run-parts /system/etc/init.d" >> /system/bin/sysinit
 echo "sleep 1" >> /system/bin/sysinit
 echo "/system/engine/feradroid.sh" >> /system/bin/sysinit
 echo "   " >> /system/bin/sysinit
 chmod 755 /system/bin/sysinit
 chown 0.2000 /system/bin/sysinit
else
 touch /system/etc/init.d/90fde
 echo "#!/system/bin/sh" >> /system/etc/init.d/90fde
 echo "   " >> /system/etc/init.d/90fde
 echo "/system/engine/feradroid.sh" >> /system/etc/init.d/90fde
 echo "   " >> /system/etc/init.d/90fde
 chmod 777 /system/etc/init.d/90fde
fi;
touch /system/etc/fde
chmod 777 /system/etc/fde
echo "1.1" > /system/etc/fde
sleep 1
umount /system
ui_print "Installation completed."
ui_print "  "
ui_print "By FeraVolt. 2017."
exit 0
